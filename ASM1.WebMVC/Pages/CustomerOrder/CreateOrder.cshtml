@page
@model ASM1.WebMVC.Pages.CustomerOrder.CreateOrderModel
@{
    ViewData["Title"] = "Create New Order";
}

<div class="container py-4">
    <h1><i class="fas fa-shopping-cart"></i> Đặt Hàng</h1>
    <hr />

    @if (Model.VariantData != null && Model.CustomerData != null)
    {
        <div class="row">
            <!-- Vehicle Info -->
            <div class="col-md-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Thông Tin Xe</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            @if (!string.IsNullOrEmpty(Model.VariantData.ImageUrl))
                            {
                                <img src="@Model.VariantData.ImageUrl"
                                     alt="@Model.VariantData.ModelName"
                                     class="img-fluid rounded shadow-sm"
                                     style="max-height: 250px; object-fit: cover;">
                            }
                            else
                            {
                                <div class="bg-light d-flex align-items-center justify-content-center rounded"
                                     style="height: 200px;">
                                    <i class="fas fa-car fa-3x text-muted"></i>
                                </div>
                            }
                        </div>

                        <h4 class="text-primary">
                            @Model.VariantData.ManufacturerName @Model.VariantData.ModelName
                        </h4>

                        <p class="mb-2"><strong>Version:</strong> @Model.VariantData.Version</p>
                        <p class="mb-2"><strong>Color:</strong> <span class="badge bg-secondary">@Model.VariantData.Color</span></p>
                        <p class="mb-2"><strong>Year:</strong> @Model.VariantData.ProductYear</p>
                        <p class="mb-2">
                            <strong>Price:</strong>
                            <span class="text-success h5" id="vehicle-price" data-price="@(Model.VariantData.Price ?? 0)">
                                $@Model.VariantData.Price?.ToString("N0")
                            </span>
                        </p>
                        <p class="mb-2">
                            <strong>Available:</strong>
                            <span class="badge bg-success">@Model.VariantData.Quantity units</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Customer Info & Order Form -->
            <div class="col-md-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Thông Tin Đặt Hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6>Thông Tin Khách Hàng</h6>
                            <p class="mb-1"><strong>Tên:</strong> @Model.CustomerData.FullName</p>
                            <p class="mb-1"><strong>Email:</strong> @Model.CustomerData.Email</p>
                            <p class="mb-1"><strong>Phone:</strong> @Model.CustomerData.PhoneNumber</p>
                            <p class="mb-1"><strong>Địa chỉ:</strong> @Model.CustomerData.Address</p>
                            <p class="mb-1"><strong>Dealer:</strong> @Model.CustomerData.DealerName</p>
                        </div>

                        <hr />

                        <form method="post">
                            <input type="hidden" asp-for="Order.VariantId" value="@Model.VariantData.VariantId" />
                            <input type="hidden" asp-for="Order.CustomerId" value="@Model.CustomerData.CustomerId" />
                            <input type="hidden" asp-for="Order.DealerId" value="@Model.CustomerData.DealerId" />

                            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                            <div class="mb-3">
                                <label asp-for="Order.Quantity" class="form-label">Số Lượng</label>
                                <input asp-for="Order.Quantity" type="number" class="form-control"
                                       min="1" max="@Model.VariantData.Quantity" value="1" />
                                <span asp-validation-for="Order.Quantity" class="text-danger"></span>
                                <small class="text-muted">Tối đa: @Model.VariantData.Quantity xe</small>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Order.Notes" class="form-label">Ghi Chú (Tùy chọn)</label>
                                <textarea asp-for="Order.Notes" class="form-control" rows="3"
                                          placeholder="Yêu cầu đặc biệt..."></textarea>
                            </div>

                            <div class="alert alert-info">
                                <strong>Tổng tiền:</strong>
                                <span id="total-price" class="h5 text-success">
                                    $@((Model.VariantData.Price ?? 0).ToString("N0"))
                                </span>
                            </div>

                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="fas fa-check"></i> Xác Nhận Đặt Hàng
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <a asp-page="/Home/Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Quay Lại
        </a>
    }
    else
    {
        <div class="alert alert-warning" role="alert">
            Vehicle variant data is not available. Please select a vehicle first.
        </div>
        <a asp-page="/Home/Index" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> Back to Vehicle Selection
        </a>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const qtyInput = document.querySelector('input[name="Order.Quantity"]');
            const totalEl = document.getElementById('total-price');
            const vehiclePriceEl = document.getElementById('vehicle-price');
            const numericPrice = parseFloat(vehiclePriceEl.dataset.price) || 0;

            function formatPriceDot(value) {
                return '$' + value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }

            function updateTotal() {
                let qty = parseInt(qtyInput.value) || 1;
                const min = parseInt(qtyInput.min) || 1;
                const max = parseInt(qtyInput.max) || 1;

                if (qty < min) qty = min;
                if (qty > max) qty = max;
                qtyInput.value = qty;

                const total = numericPrice * qty;
                totalEl.textContent = formatPriceDot(total);
            }

            qtyInput.value = 1;
            updateTotal();

            qtyInput.addEventListener('input', updateTotal);
            qtyInput.addEventListener('change', updateTotal);
        });
    </script>
}
